<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Map Test</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    function loadGoogleMaps(apiKey) {
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    fetch("http://localhost:3000/maps")
      .then(res => res.json())
      .then(data => {
        loadGoogleMaps(data.apiKey);
      })
      .catch(err => {
        console.error("APIキー取得失敗", err);
      });

    function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: { lat: 35.681236, lng: 139.767125 }
      });

      // 現在地
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const current = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          map.setCenter(current);

          new google.maps.Marker({
            position: current,
            map: map,
            title: "現在地"
          });
        });
      }

      // 仮ピン
      fetch("http://localhost:3000/map")
        .then(res => res.json())
        .then(data => {
          data.forEach(pin => {
            new google.maps.Marker({
              position: { lat: pin.lat, lng: pin.lng },
              map: map,
              title: pin.title
            });
          });
        })
        .catch(err => {
          console.error("ピン取得失敗", err);
        });
    }
  </script>
</body>
</html>
